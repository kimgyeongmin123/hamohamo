<!DOCTYPE html>
<html lang="en" xmlns:th="http://www.thymeleaf.org">
<head>
  <meta charset="UTF-8">
  <title>채팅</title>
  <!-- CSS 및 기타 필요한 스타일시트 포함 -->
</head>
<body>

<h1>채팅방</h1>

<div id="chat-box">
  <!-- 채팅 내용 표시 -->
  <div th:each="message : ${list}">
    <!-- 닉네임과 내용 표시 -->
    <p th:text="${message.other_nick + ': ' + message.content}"></p>
  </div>
</div>

<!-- 메시지 전송 폼 -->
<form id="messageForm">
  <!-- 수신자의 닉네임을 hidden 필드로 전달 -->
  <input type="hidden" id="otherNick" th:value="${sendNickname}" />
  <!-- 메시지 내용 입력 필드 -->
  <input type="text" id="content" />
  <!-- 전송 버튼 -->
  <button type="button" onclick="sendMessage()">전송</button>
</form>

<script src="https://code.jquery.com/jquery-3.6.4.min.js"></script>
<script>

  // 메시지 전송 함수
  function sendMessage() {
      var otherNick = document.getElementById('otherNick').value;
      var content = document.getElementById('content').value;

      // Ajax를 사용하여 메시지 전송
      $.ajax({
          type: 'POST',
          url: '/message/send',
          data: { otherNick: otherNick, content: content },
          success: function () {
              updateChat();
          },
          error: function () {
              alert('메시지 전송 오류');
          }
      });

      // 메시지 입력 필드 초기화
      document.getElementById('content').value = '';
  }

  // 채팅 내용 갱신 함수
  function updateChat() {
      // 현재 선택된 채팅 상대의 닉네임 가져오기
      var sendNickname = document.getElementById('otherNick').value;

      // Ajax를 사용하여 최근 채팅 메시지를 가져오기
      $.ajax({
          type: 'GET',
          url: '/message/chat/' + sendNickname,
          success: function (messages) {
              // 메시지를 화면에 출력하는 로직을 추가
              var chatBox = document.getElementById('chat-box');
              chatBox.innerHTML = '';  // 채팅 박스 초기화

              messages.forEach(function (message) {
                  var messageElement = document.createElement('p');
                  messageElement.textContent = message.other_nick + ': ' + message.content;
                  chatBox.appendChild(messageElement);
              });
          },
          error: function () {
              // 에러 처리
              alert('채팅 내용 갱신 오류');
          }
      });
  }

</script>

</body>
</html>